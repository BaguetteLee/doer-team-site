<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>任务接单平台·支付账户设置</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
        :root {
            --primary: #3b7ddd;
            --primary-light: #e8f0fe;
            --secondary: #6c757d;
            --red: #dc3545;
            --red-light: #fde8ea;
            --green: #28a745;
            --green-light: #e8f5e9;
            --white: #ffffff;
            --light: #f8f9fa;
            --dark: #343a40;
            --border: #e2e8f0;
        }
        
        body {
            background-color: #f5f6f8;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #2d3748;
        }
        
        .sidebar {
            background-color: var(--white);
            color: #4a5568;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            padding-top: 60px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            border-right: 1px solid var(--border);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .sidebar .nav-link {
            color: #4a5568;
            padding: 0.8rem 1rem;
            margin: 0.1rem 0.5rem;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: var(--primary);
            background-color: var(--primary-light);
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
            color: #718096;
        }
        
        .sidebar .nav-link.active i, .sidebar .nav-link:hover i {
            color: var(--primary);
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            padding-top: 80px;
            transition: margin-left 0.3s;
        }
        
        .navbar {
            background-color: var(--white);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid var(--border);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1030;
            padding-left: 250px;
            transition: padding-left 0.3s;
        }
        
        .stat-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.08);
        }
        
        .dashboard-card {
            background: var(--white);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.04);
            margin-bottom: 24px;
            border: none;
        }
        
        .card-header {
            background-color: var(--white);
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            padding: 1rem 1.5rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .btn {
            border-radius: 6px;
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.2s;
        }
        
        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-primary:hover {
            background-color: #2c6ac8;
            border-color: #2c6ac8;
        }
        
        .btn-outline-primary {
            color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary);
            color: white;
        }
        
        .activity-item {
            border-left: 3px solid var(--primary);
            padding-left: 15px;
            margin-bottom: 15px;
        }
        
        .activity-time {
            font-size: 0.8rem;
            color: var(--secondary);
        }
        
        .badge {
            border-radius: 6px;
            font-weight: 500;
            padding: 0.35em 0.65em;
        }
        
        .navbar-brand {
            color: var(--primary);
            font-weight: 700;
        }
        
        .dropdown-menu {
            border-radius: 8px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border);
        }
        
        .dropdown-item {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin: 0.1rem 0.5rem;
            width: auto;
        }
        
        h4, h6 {
            color: #2d3748;
            font-weight: 600;
        }
        
        /* 卡片顶部边框样式 */
        .card-border-red {
            border-top: 4px solid var(--red);
        }
        
        .card-border-blue {
            border-top: 4px solid var(--primary);
        }
        
        .card-border-green {
            border-top: 4px solid var(--green);
        }
        
        .text-red {
            color: var(--red);
        }
        
        .text-green {
            color: var(--green);
        }

        /* 响应式调整 */
        @media (max-width: 992px) {
            .sidebar {
                width: 80px;
                padding-top: 70px;
            }
            
            .sidebar .nav-link span {
                display: none;
            }
            
            .sidebar .nav-link i {
                margin-right: 0;
                font-size: 1.2rem;
            }
            
            .main-content {
                margin-left: 80px;
            }
            
            .navbar {
                padding-left: 80px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 250px;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .navbar {
                padding-left: 15px;
            }
            
            .navbar-toggler {
                display: block;
            }
        }
        
        .navbar-toggler {
            display: none;
            border: none;
            font-size: 1.25rem;
        }
        
        .navbar-toggler:focus {
            box-shadow: none;
        }
    </style>
<style id="doer-doctheme-enhance">
/* 侧边栏色块与 active 高亮（与发布平台统一） */
:root{ --sidebar-active-bg: rgba(13,110,253,.10); --sidebar-active:#0d6efd; }
.sidebar .nav-link{ display:flex; align-items:center; }
.sidebar .nav-link i{ opacity:.9; }
.sidebar .nav-link.active{ color:var(--sidebar-active); background:var(--sidebar-active-bg); font-weight:600; }
.nav-section{ margin:.75rem .25rem .25rem; font-size:.8125rem; color:#6c757d; display:flex; align-items:center; gap:.5rem; }
.nav-section .dot{ width:10px; height:10px; border-radius:2px; display:inline-block; }
.dot--platform{ background:#0d6efd; }
.dot--task{ background:#20c997; }
.dot--user{ background:#fd7e14; }
.dot--settings{ background:#6f42c1; }
</style><link rel="stylesheet" href="p1-unify.css"/>
<link rel="stylesheet" href="p2-unify.css"/>
</head>
<body>
<!-- 顶部导航栏 -->
<nav class="navbar navbar-expand-lg navbar-light">
<div class="container-fluid">
<button class="navbar-toggler" id="sidebarToggle" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<a class="navbar-brand" href="#">
<strong><i class="bi bi-lightning-charge me-2"></i>任务接单管理平台</strong>
</a>
<div class="collapse navbar-collapse" id="navbarNav">
<ul class="navbar-nav ms-auto me-5">
<li class="nav-item dropdown">
<a aria-expanded="false" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" id="navbarDropdown" role="button">
<i class="bi bi-bell"></i>
<span class="badge bg-danger">3</span>
</a>
<ul class="dropdown-menu dropdown-menu-end">
<li><a class="dropdown-item" href="#"><i class="bi bi-plus-circle me-2"></i>5个新任务可接单</a></li>
<li><a class="dropdown-item" href="#"><i class="bi bi-cash-coin me-2"></i>2个提现申请待处理</a></li>
<li><hr class="dropdown-divider"/></li>
<li><a class="dropdown-item" href="#"><i class="bi bi-list-ul me-2"></i>查看所有通知</a></li>
</ul>
</li>
<li class="nav-item dropdown ms-2">
<a class="nav-link dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown" href="#" id="userDropdown" role="button">
<i class="bi bi-person-circle me-2"></i> 接单管理员
                        </a>
<ul class="dropdown-menu dropdown-menu-end">
<li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>个人资料</a></li>
<li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>设置</a></li>
<li><hr class="dropdown-divider"/></li>
<li><a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right me-2"></i>退出</a></li>
</ul>
</li>
</ul>
</div>
</div>
</nav>
<div class="sidebar">
<div class="position-sticky">
<ul class="nav flex-column">
<!-- 侧边主导航：平台 / 任务 / 用户 / 设置（6字菜单名）；仅当前页链接添加  -->
<!-- 平台组 -->
<li class="nav-section"><span class="dot dot--platform"></span><span>平台</span></li>
<li class="nav-item">
<a class="nav-link " href="doer-team-analytics-dashboard.html">
<i class="bi bi-speedometer2 me-2"></i> 平台总仪表盘
  </a>
</li>
<li>
<a class="nav-link" active href="doer-team-finance-platform-fund-flow.html">
<i class="bi bi-cash-coin me-2"></i> 平台资金流水
  </a>
</li>
<!-- 任务组 -->
<li class="nav-section"><span class="dot dot--task"></span><span>任务</span></li>
<li>
<a class="nav-link" href="doer-team-orders-situation.html">
<i class="bi bi-cart-check me-2"></i> 任务接单情况
  </a>
</li>
<li>
<a class="nav-link" href="doer-team-tasks-completion.html">
<i class="bi bi-check2-circle me-2"></i> 任务完成情况
  </a>
</li>
<li>
<a class="nav-link" href="doer-team-tasks-list.html">
<i class="bi bi-list-task me-2"></i> 可接任务列表
  </a>
</li>
<!-- 用户组 -->
<li class="nav-section"><span class="dot dot--user"></span><span>用户</span></li>
<li>
<a class="nav-link" href="doer-team-users-list.html">
<i class="bi bi-people me-2"></i> 平台用户列表
  </a>
</li>
<li>
<a class="nav-link" href="doer-team-finance-withdrawal-list.html">
<i class="bi bi-bank me-2"></i> 用户提现列表
  </a>
</li>
<li>
<a class="nav-link" href="doer-team-finance-user-fund-flow.html">
<i class="bi bi-journal-text me-2"></i> 用户资金流水
  </a>
</li>
<!-- 设置组 -->
<li class="nav-section"><span class="dot dot--settings"></span><span>设置</span></li>
<li>
<a class="nav-link" href="doer-team-settings-categories.html">
<i class="bi bi-sliders me-2"></i> 业务分类概览
  </a>
</li>
<li>
<a class="nav-link" href="doer-team-system-api-monitoring.html">
<i class="bi bi-activity me-2"></i> 接口管理监控
  </a>
</li>
<li>
<a class="nav-link active" href="doer-team-finance-payment-account.html">
<i class="bi bi-credit-card me-2"></i> 支付账户设置
  </a>
</li>
<li>
<a class="nav-link" href="doer-team-account-management.html">
<i class="bi bi-person-gear me-2"></i> 账号管理设置
  </a>
</li>
<li>
<a class="nav-link" href="doer-team-team-profile.html">
<i class="bi bi-building-gear me-2"></i> 团队资料设置
  </a>
</li>
</ul>
</div>
</div>
<main class="main-content main">
    <!-- 抬头 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">支付账户设置（本接单平台）</h5>
      <div class="text-muted small">口径：与总部提现审核一致</div>
    </div>

    <!-- 顶部概览：余额/可提现/冻结，统一口径展示 -->
    <section class="row g-3 mb-3">
      <div class="col-12 col-lg-4">
        <div class="card h-100"><div class="card-body">
          <div class="metric-sub">账户总余额</div>
          <div class="metric-value" id="kBalTotal">¥ —</div>
          <div class="text-muted small">冻结金额：<span id="kBalFrozen">¥ —</span></div>
        </div></div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="card h-100"><div class="card-body">
          <div class="metric-sub">可提现余额</div>
          <div class="metric-value" id="kBalAvail">¥ —</div>
          <div class="text-muted small">今日可提现：<span id="kBalToday">¥ —</span></div>
        </div></div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="card h-100"><div class="card-body">
          <div class="metric-sub">累计收入</div>
          <div class="metric-value" id="kBalIncome">¥ —</div>
          <div class="text-muted small">自账户开通以来</div>
        </div></div>
      </div>
    </section>

    <!-- Tab 导航：收款账户 / 申请提现 / 提现记录 -->
    <ul class="nav nav-tabs mb-3" id="payTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" data-bs-target="#pane-accounts" data-bs-toggle="tab" id="tab-accounts" role="tab" type="button">
          <i class="bi bi-credit-card me-1"></i> 收款账户管理
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-target="#pane-withdraw" data-bs-toggle="tab" id="tab-withdraw" role="tab" type="button">
          <i class="bi bi-cash-coin me-1"></i> 申请提现
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-target="#pane-history" data-bs-toggle="tab" id="tab-history" role="tab" type="button">
          <i class="bi bi-clock-history me-1"></i> 申请提现记录
        </button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- ========== 收款账户管理 ========== -->
      <div class="tab-pane fade show active" id="pane-accounts" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="small text-muted">收款账户将用于总部打款，请确保实名信息准确。</div>
          <button class="btn btn-primary btn-sm" data-bs-target="#acctModal" data-bs-toggle="modal"><i class="bi bi-plus-lg me-1"></i>新增账户</button>
        </div>
        <div class="row" id="acctGrid"></div>
        <div class="placeholder-muted small" id="acctEmpty" style="display:none">尚未添加任何收款账户。</div>
      </div>

      <!-- ========== 申请提现 ========== -->
      <div class="tab-pane fade" id="pane-withdraw" role="tabpanel">
        <div class="card"><div class="card-body">
          <form class="row g-3" id="wdForm">
            <!-- 选择收款账户 -->
            <div class="col-12 col-md-6">
              <label class="form-label">收款账户</label>
              <select class="form-select" id="wdAcct"></select>
              <div class="form-text">默认优先选择「默认账户」。如无账户请先在上方“收款账户管理”添加。</div>
            </div>
            <!-- 提现金额 -->
            <div class="col-12 col-md-3">
              <label class="form-label">提现金额（元）</label>
              <input class="form-control" id="wdAmount" min="0" step="0.01" type="number"/>
              <div class="form-text">单笔限额：<span id="limitSingle">—</span>；当日剩余限额：<span id="limitDaily">—</span>；费率：<span id="feeRateLabel">—</span></div>
            </div>
            <!-- 备注 -->
            <div class="col-12">
              <label class="form-label">备注（选填）</label>
              <input class="form-control" id="wdRemark" placeholder="如：月度结算提现" type="text"/>
            </div>
            <!-- 风险与余额提示 -->
            <div class="col-12">
              <div class="alert alert-info py-2 mb-0">
                <i class="bi bi-info-circle me-1"></i>
                审核流程对齐总部：<span class="badge text-bg-light">待审核 → 已通过待打款 → 已打款待确认 → 已完成</span>；如不符合规范，将可能<span class="text-danger">已驳回</span>。
              </div>
            </div>
            <div class="col-12 d-flex justify-content-end gap-2">
              <button class="btn btn-outline-secondary" id="wdReset" type="button">重置</button>
              <button class="btn btn-primary" type="submit"><i class="bi bi-rocket-takeoff me-1"></i>提交申请</button>
            </div>
          </form>
        </div></div>
      </div>

      <!-- ========== 提现记录 ========== -->
      <div class="tab-pane fade" id="pane-history" role="tabpanel">
        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between">
            <div>我的提现申请 <span class="pill" id="countHistory">—</span></div>
            <div class="d-flex align-items-center gap-2">
              <select class="form-select form-select-sm" id="hisState" style="width:160px">
                <option value="">全部状态</option>
                <option>待审核</option>
                <option>已通过待打款</option>
                <option>已打款待确认</option>
                <option>已完成</option>
                <option>已驳回</option>
              </select>
              <button class="btn btn-sm btn-light" id="btnExport"><i class="bi bi-download me-1"></i>导出当前页 CSV</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0" id="tblHistory">
              <thead class="table-light">
                <tr>
                  <th>提现ID</th>
                  <th>申请时间</th>
                  <th class="text-end">金额（元）</th>
                  <th>收款账户</th>
                  <th>状态</th>
                  <th>备注</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="placeholder-muted small p-3" id="hisEmpty" style="display:none;">暂无记录。</div>
          </div>
          <div class="d-flex justify-content-between align-items-center px-3 py-2">
            <div class="small text-muted" id="pginfo">共0条 · 第1/1页</div>
            <div>
              <button class="btn btn-light btn-sm me-1" id="pgPrev">上一页</button>
              <button class="btn btn-light btn-sm" id="pgNext">下一页</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>


  <!-- ========== 账户新增/编辑 Modal ========== -->
  <div aria-hidden="true" class="modal fade" id="acctModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">收款账户</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form class="row g-3" id="acctForm">
            <!-- 账户类型 -->
            <div class="col-12 col-md-6">
              <label class="form-label">账户类型</label>
              <select class="form-select" id="fType">
                <option value="alipay">支付宝</option>
                <option value="wechat">微信</option>
                <option value="bank_pub">银行卡（对公）</option>
                <option value="bank_priv">银行卡（个人）</option>
              </select>
            </div>
            <!-- 实名 -->
            <div class="col-12 col-md-6">
              <label class="form-label">账户实名</label>
              <input class="form-control" id="fReal" placeholder="公司抬头/姓名"/>
            </div>
            <!-- 账号 -->
            <div class="col-12">
              <label class="form-label">收款账号 / 卡号</label>
              <input class="form-control" id="fAcct" placeholder="邮箱/手机号/卡号"/>
            </div>
            <!-- 开户行（仅对公/个人银行卡展示） -->
            <div class="col-12" id="bankExtra" style="display:none;">
              <label class="form-label">开户行信息</label>
              <input class="form-control" id="fBank" placeholder="如：招商银行上海XX支行"/>
            </div>
            <!-- 默认账户 -->
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" id="fDefault" type="checkbox"/>
                <label class="form-check-label" for="fDefault">设为默认账户</label>
              </div>
            </div>
            <input id="fId" type="hidden"/>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary" id="btnSaveAcct">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== 详情 Modal（提现单） ========== -->
  <div aria-hidden="true" class="modal fade" id="wdDetail" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">提现详情</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="row g-3 small">
            <div class="col-12 col-md-6">
              <div class="card"><div class="card-body">
                <div class="fw-semibold mb-2">申请信息</div>
                <div>提现ID：<span id="dId">—</span></div>
                <div>申请时间：<span id="dTime">—</span></div>
                <div>金额：<span id="dAmount">—</span></div>
                <div>状态：<span class="badge badge-state" data-state="待审核" id="dState">待审核</span></div>
                <div>备注：<span id="dRemark">—</span></div>
              </div></div>
            </div>
            <div class="col-12 col-md-6">
              <div class="card"><div class="card-body">
                <div class="fw-semibold mb-2">收款账户</div>
                <div>类型：<span id="dAcctType">—</span></div>
                <div>实名：<span id="dReal">—</span></div>
                <div>账号：<span id="dMask">—</span></div>
                <div id="dBankRow" style="display:none;">开户行：<span id="dBank">—</span></div>
              </div></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-bs-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast 容器 -->
  <div id="toastBox"></div>

  <!-- 依赖脚本 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  /* ================== 工具方法（中文注释） ================== */
  const today = new Date('2025-09-11T12:00:00'); // 固定演示时间
  const fmtCNY = (n)=> '¥ ' + Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  const randId = ()=> Math.floor(202509110000 + Math.random()*999).toString();
  const maskAcct = (s)=>{
    // 账号脱敏：邮箱保留前2+后域，手机号保留前三后四，卡号保留前4后4
    if(!s) return '—';
    if(/@/.test(s)){ const [a,b]=s.split('@'); return (a.slice(0,2)+'***@'+b); }
    if(/^\\d{11}$/.test(s)){ return s.slice(0,3)+'****'+s.slice(-4); }
    const digits = s.replace(/\\s+/g,'');
    if(/\\d{12,}/.test(digits)){ return digits.slice(0,4)+' **** **** '+digits.slice(-4); }
    return s.slice(0,2)+'***'+s.slice(-2);
  };
  function toast(msg,type='success'){
    const w = document.createElement('div');
    w.className = 'toast align-items-center text-bg-' + (type==='success'?'success':type==='danger'?'danger':'secondary') + ' border-0 show';
    w.role = 'alert'; w.ariaLive = 'assertive'; w.ariaAtomic = 'true';
    w.style.marginTop = '8px';
    w.innerHTML = '<div class="d-flex"><div class="toast-body">'+msg+'</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>';
    document.getElementById('toastBox').appendChild(w);
    setTimeout(()=> w.remove(), 2600);
  }

  // 侧边栏折叠（移动端）
  document.getElementById('sidebarToggle')?.addEventListener('click', function(){
    document.querySelector('.sidebar')?.classList.toggle('show');
  });

  /* ================== 模拟账户/余额/提现记录（本平台） ================== */
  // 余额口径（与 Dashboard 展示对齐）
  const balance = { total: 12642.50, frozen: 800.00, available: 11842.50, todayLimit: 5000.00, income: 56289.00 };

  // 收款账户（支持：支付宝/微信/银行卡-对公/银行卡-个人）
  let accounts = [
    {id:'A1', type:'alipay',  real:'陈雷',   acct:'pl-team@pay.com', bank:'',   isDefault:true},
    {id:'A2', type:'bank_pub',real:'上海星火网络科技有限公司', acct:'122055669988001', bank:'招商银行上海XX支行', isDefault:false},
    {id:'A3', type:'wechat',  real:'王强',   acct:'wxid_88990011',   bank:'',   isDefault:false}
  ];

  // 提现记录（状态对齐总部审核页）
  let history = [
    {id:'20250911021', ts:'2025-09-11 11:05:31', amount:4200.00, acctId:'A2', state:'待审核', remark:'季度结算提现'},
    {id:'20250911022', ts:'2025-09-10 16:20:00', amount:1800.50, acctId:'A1', state:'已通过待打款', remark:'—'},
    {id:'20250909003', ts:'2025-09-09 10:01:12', amount:1200.00, acctId:'A1', state:'已完成', remark:'—'},
    {id:'20250907001', ts:'2025-09-07 09:11:43', amount:3000.00, acctId:'A3', state:'已驳回', remark:'资料不完整'},
  ];

  /* ================== 页面状态 ================== */
  const st = {
    pageSize: 8,
    page: 1,
    filterState: '',
    feeRate: 0.003,           // 手续费费率（示例：0.3%）
    minSingle: 100.00,        // 单笔最小
    maxSingle: 20000.00,      // 单笔最大
    dailyRemain: balance.todayLimit // 当日剩余额度
  };

  /* ================== 初始化渲染 ================== */
  (function init(){
    try{
      // 顶部余额
      document.getElementById('kBalTotal').textContent  = fmtCNY(balance.total);
      document.getElementById('kBalFrozen').textContent = fmtCNY(balance.frozen);
      document.getElementById('kBalAvail').textContent  = fmtCNY(balance.available);
      document.getElementById('kBalToday').textContent  = fmtCNY(balance.todayLimit);
      document.getElementById('kBalIncome').textContent = fmtCNY(balance.income);

      // 限额/费率标签
      document.getElementById('limitSingle').textContent = `${st.minSingle} ~ ${st.maxSingle}`;
      document.getElementById('limitDaily').textContent  = st.dailyRemain.toFixed(2);
      document.getElementById('feeRateLabel').textContent= (st.feeRate*100).toFixed(1)+'%';

      // 收款账户栅格 + 下拉
      renderAccounts();
      fillAcctSelect();

      // 提现记录
      renderHistory();

      // 根据 URL 定位到“申请提现”选项卡（hash 或 query）
      const needWithdraw = (location.hash === '#withdraw') || /(?:^|[?&])tab=withdraw(?:&|$)/.test(location.search);
      if(needWithdraw){
        const link = document.getElementById('tab-withdraw');
        if(window.bootstrap && bootstrap.Tab && link){
          bootstrap.Tab.getOrCreateInstance(link).show();
        }
      }
    }catch(e){
      console.error(e);
      // 兜底提示，防止整页白屏
      const main = document.querySelector('main'); 
      if(main) main.insertAdjacentHTML('afterbegin','<div class="alert alert-warning">初始化遇到问题：'+(e.message||e)+'</div>');
    }
  })();

  /* ================== 收款账户：渲染与操作 ================== */
  function acctTypeText(t){
    return t==='alipay'?'支付宝':t==='wechat'?'微信':t==='bank_pub'?'银行卡（对公）':'银行卡（个人）';
  }
  function acctBadgeCls(t){
    return t==='alipay'?'badge-type-alipay':t==='wechat'?'badge-type-wechat':'badge-type-bank';
  }
  function renderAccounts(){
    const grid = document.getElementById('acctGrid'); grid.innerHTML = '';
    if(accounts.length===0){ document.getElementById('acctEmpty').style.display='block'; return; }
    document.getElementById('acctEmpty').style.display='none';

    for(const a of accounts){
      const col = document.createElement('div');
      col.className = 'col-12 col-md-6 col-xl-4 mb-3';
      col.innerHTML = `
        <div class="card acct-card h-100">
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-semibold">${acctTypeText(a.type)} <span class="badge badge-type ${acctBadgeCls(a.type)} ms-1">${a.type==='bank_pub'?'对公':a.type==='bank_priv'?'个人':acctTypeText(a.type)}</span></div>
                <div class="text-muted small">实名：${a.real||'-'}</div>
              </div>
              ${a.isDefault?'<span class="badge text-bg-light">默认</span>':''}
            </div>
            <div class="mt-2 small">账号：<span class="text-mono">${maskAcct(a.acct)}</span></div>
            ${a.type.startsWith('bank')? `<div class="small">开户行：<span class="text-mono">${a.bank||'-'}</span></div>` : ''}
            <div class="mt-auto d-flex gap-2 pt-2">
              <button class="btn btn-outline-primary btn-sm" data-act="edit" data-id="${a.id}"><i class="bi bi-pencil me-1"></i>编辑</button>
              <button class="btn btn-outline-secondary btn-sm" data-act="default" data-id="${a.id}" ${a.isDefault?'disabled':''}><i class="bi bi-star me-1"></i>设为默认</button>
              <button class="btn btn-outline-danger btn-sm" data-act="del" data-id="${a.id}"><i class="bi bi-trash me-1"></i>删除</button>
            </div>
          </div>
        </div>`;
      grid.appendChild(col);
    }

    // 绑定按钮
    grid.querySelectorAll('button[data-act="edit"]').forEach(b=> b.addEventListener('click', ()=> openAcctModal(b.getAttribute('data-id'))));
    grid.querySelectorAll('button[data-act="default"]').forEach(b=> b.addEventListener('click', ()=> setDefault(b.getAttribute('data-id'))));
    grid.querySelectorAll('button[data-act="del"]').forEach(b=> b.addEventListener('click', ()=> delAcct(b.getAttribute('data-id'))));
  }
  function openAcctModal(id){
    // 填充已有或重置表单
    const form = document.getElementById('acctForm');
    form.reset();
    document.getElementById('bankExtra').style.display='none';
    if(id){
      const a = accounts.find(x=>x.id===id);
      document.getElementById('fId').value = a.id;
      document.getElementById('fType').value = a.type;
      document.getElementById('fReal').value = a.real;
      document.getElementById('fAcct').value = a.acct;
      document.getElementById('fBank').value = a.bank||'';
      document.getElementById('fDefault').checked = !!a.isDefault;
      if(a.type.startsWith('bank')) document.getElementById('bankExtra').style.display='';
    } else {
      document.getElementById('fId').value = '';
    }
    if(window.bootstrap && bootstrap.Modal){
      bootstrap.Modal.getOrCreateInstance('#acctModal').show();
    }else{
      alert('请在有网络的环境下预览以启用弹窗；当前将仅展示静态内容。');
    }
  }
  document.getElementById('fType').addEventListener('change', function(){
    document.getElementById('bankExtra').style.display = this.value.startsWith('bank')? '' : 'none';
  });
  document.getElementById('btnSaveAcct').addEventListener('click', function(){
    const id = document.getElementById('fId').value || ('A'+(Math.random()*10000|0));
    const type = document.getElementById('fType').value;
    const real = document.getElementById('fReal').value.trim();
    const acct = document.getElementById('fAcct').value.trim();
    const bank = document.getElementById('fBank').value.trim();
    const setDef = document.getElementById('fDefault').checked;

    // 简单校验
    if(!real || !acct){ toast('请填写实名与账号', 'danger'); return; }
    if(type.startsWith('bank') && !bank){ toast('银行卡需填写开户行信息', 'danger'); return; }

    const exist = accounts.find(x=>x.id===id);
    if(exist){
      exist.type=type; exist.real=real; exist.acct=acct; exist.bank=bank; exist.isDefault=setDef;
    }else{
      accounts.unshift({id, type, real, acct, bank, isDefault:setDef});
    }
    if(setDef){ accounts.forEach(x=> x.isDefault = (x.id===id)); }

    // 刷新视图
    renderAccounts(); fillAcctSelect();
    if(window.bootstrap && bootstrap.Modal){
      const m = bootstrap.Modal.getInstance(document.getElementById('acctModal')); m && m.hide();
    }
    toast('账户已保存');
  });
  function setDefault(id){
    accounts.forEach(x=> x.isDefault = (x.id===id));
    renderAccounts(); fillAcctSelect();
    toast('已设为默认账户');
  }
  function delAcct(id){
    // 若删除默认账户，自动将首个账户设为默认
    const idx = accounts.findIndex(x=> x.id===id);
    if(idx<0) return;
    const wasDefault = accounts[idx].isDefault;
    accounts.splice(idx,1);
    if(accounts.length && wasDefault){ accounts[0].isDefault = true; }
    renderAccounts(); fillAcctSelect();
    toast('账户已删除', 'secondary');
  }
  function fillAcctSelect(){
    const sel = document.getElementById('wdAcct'); sel.innerHTML = '';
    for(const a of accounts){
      const opt = document.createElement('option');
      opt.value = a.id;
      opt.textContent = `${acctTypeText(a.type)}｜${a.real}｜${maskAcct(a.acct)}`;
      sel.appendChild(opt);
    }
    const def = accounts.find(x=> x.isDefault) || accounts[0];
    if(def) sel.value = def.id;
  }

  /* ================== 申请提现：计算与提交 ================== */
  document.getElementById('wdReset').addEventListener('click', function(){
    document.getElementById('wdAmount').value=''; document.getElementById('wdRemark').value='';
  });

  document.getElementById('wdForm').addEventListener('submit', function(e){
    e.preventDefault();
    const acctId = document.getElementById('wdAcct').value;
    const amt = parseFloat(document.getElementById('wdAmount').value||'0');
    const remark = document.getElementById('wdRemark').value.trim();

    // 校验：账户存在/金额区间/当日额度/可用余额
    if(!acctId){ toast('请选择收款账户','danger'); return; }
    if(!(amt>0)){ toast('请输入正确的提现金额','danger'); return; }
    if(amt < st.minSingle || amt > st.maxSingle){ toast(`单笔限额 ${st.minSingle}~${st.maxSingle}`,'danger'); return; }
    if(amt > st.dailyRemain){ toast('超出当日剩余限额','danger'); return; }
    if(amt > balance.available){ toast('超出可提现余额','danger'); return; }

    // 通过校验：生成提现单（状态=待审核），扣减当日限额与可用余额，增加冻结
    const id = randId();
    const ts = new Date(today).toISOString().slice(0,19).replace('T',' ');
    history.unshift({id, ts, amount:amt, acctId, state:'待审核', remark: remark || '—'});
    balance.available = +(balance.available - amt).toFixed(2);
    balance.frozen    = +(balance.frozen + amt).toFixed(2);
    st.dailyRemain    = +(st.dailyRemain - amt).toFixed(2);

    // 刷新视图
    document.getElementById('kBalAvail').textContent  = fmtCNY(balance.available);
    document.getElementById('kBalFrozen').textContent = fmtCNY(balance.frozen);
    document.getElementById('limitDaily').textContent = st.dailyRemain.toFixed(2);
    renderHistory();

    // 清空表单
    document.getElementById('wdAmount').value=''; document.getElementById('wdRemark').value='';

    // 切换到记录 Tab 并提示（Bootstrap 不存在时忽略）
    const tabBtn = document.getElementById('tab-history');
    if(window.bootstrap && bootstrap.Tab && tabBtn){
      bootstrap.Tab.getOrCreateInstance(tabBtn).show();
    }
    toast('提现申请已提交，等待总部审核');
  });

  /* ================== 提现记录列表（筛选/分页/导出/详情） ================== */
  function acctById(id){ return accounts.find(x=> x.id===id)||{}; }

  function getFiltered(){
    let list = history.slice();
    if(st.filterState){ list = list.filter(x=> x.state===st.filterState); }
    return list;
  }
  function renderHistory(){
    const tbody = document.querySelector('#tblHistory tbody'); tbody.innerHTML = '';
    const data = getFiltered();
    const total = data.length;
    const pages = Math.max(1, Math.ceil(total/st.pageSize));
    if(st.page>pages) st.page = pages;
    const start = (st.page-1)*st.pageSize;
    const pageData = data.slice(start, start+st.pageSize);

    document.getElementById('hisEmpty').style.display = pageData.length? 'none':'';
    document.getElementById('countHistory').textContent = total;

    for(const row of pageData){
      const acct = acctById(row.acctId);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><code class="text-body-secondary">#${row.id}</code></td>
        <td>${row.ts}</td>
        <td class="text-end">${row.amount.toFixed(2)}</td>
        <td>${acctTypeText(acct.type||'')}｜${acct.real||'-'}｜<span class="text-mono">${maskAcct(acct.acct||'')}</span></td>
        <td><span class="badge badge-state" data-state="${row.state}">${row.state}</span></td>
        <td>${row.remark||'—'}</td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary btn-detail" data-id="${row.id}">详情</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    }
    document.getElementById('pginfo').textContent = `共${total}条 · 第${st.page}/${pages}页`;

    // 绑定详情按钮
    tbody.querySelectorAll('.btn-detail').forEach(btn=>{
      btn.addEventListener('click', ()=> openDetail(btn.getAttribute('data-id')));
    });
  }

  document.getElementById('hisState').addEventListener('change', function(){
    st.filterState = this.value || '';
    st.page = 1; renderHistory();
  });
  document.getElementById('pgPrev').addEventListener('click', function(){
    if(st.page>1){ st.page--; renderHistory(); }
  });
  document.getElementById('pgNext').addEventListener('click', function(){
    const total = getFiltered().length; const pages = Math.max(1, Math.ceil(total/st.pageSize));
    if(st.page<pages){ st.page++; renderHistory(); }
  });
  document.getElementById('btnExport').addEventListener('click', function(){
    const data = getFiltered().slice((st.page-1)*st.pageSize, (st.page-1)*st.pageSize + st.pageSize);
    if(!data.length) return;
    const header = ['提现ID','申请时间','金额(元)','收款账户','状态','备注'];
    const rows = data.map(x=>{
      const a = acctById(x.acctId);
      return [x.id, x.ts, x.amount.toFixed(2), `${acctTypeText(a.type||'')}|${a.real||'-'}|${maskAcct(a.acct||'')}`, x.state, x.remark||'—'];
    });
    const csv = [header.join(','), ...rows.map(r=> r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))].join('\\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = '提现记录_当前页.csv'; a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 500);
  });

  /* ================== 详情弹窗填充（Bootstrap 兜底） ================== */
  const detailModal = (window.bootstrap && bootstrap.Modal) ? bootstrap.Modal.getOrCreateInstance('#wdDetail') : { show: ()=>alert('详情（简化）：请在联网环境查看完整弹窗') };
  function openDetail(id){
    const row = history.find(x=> x.id===id); if(!row) return;
    const a = acctById(row.acctId);

    document.getElementById('dId').textContent = '#'+row.id;
    document.getElementById('dTime').textContent = row.ts;
    document.getElementById('dAmount').textContent = row.amount.toFixed(2) + ' 元';
    const stEl = document.getElementById('dState'); stEl.textContent = row.state; stEl.setAttribute('data-state', row.state);
    document.getElementById('dRemark').textContent = row.remark||'—';

    document.getElementById('dAcctType').textContent = acctTypeText(a.type||'');
    document.getElementById('dReal').textContent = a.real||'-';
    document.getElementById('dMask').textContent = maskAcct(a.acct||'');
    const bankRow = document.getElementById('dBankRow'); const dBank = document.getElementById('dBank');
    if(a.type && a.type.startsWith('bank')){ bankRow.style.display=''; dBank.textContent = a.bank||'-'; } else { bankRow.style.display='none'; }

    detailModal.show();
  }

  /* ================== “查看全部通知”联动（Bootstrap 兜底） ================== */
  document.addEventListener('DOMContentLoaded', function () {
    const link = document.querySelector('[data-bs-target="#modalAllNotifications"]');
    if(link){
      link.addEventListener('click', function (e) {
        e.preventDefault();
        const modalEl = document.getElementById('modalAllNotifications');
        if(!modalEl) return;
        if(window.bootstrap && bootstrap.Modal){
          bootstrap.Modal.getOrCreateInstance(modalEl).show();
        }else{
          alert('通知（简化预览）：提现打款成功、资金流水两条、通过率提示等。');
        }
      });
    }
  });
  </script>

  <!-- 通知模态框（与接单平台统一风格） -->
  <div class="modal fade" id="modalAllNotifications" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">全部通知</h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
        </div>
        <div class="modal-body">
          <ul class="list-group">
            <li class="list-group-item d-flex align-items-start">
              <i class="bi bi-cash-coin me-2 mt-1"></i>
              <div>
                <div class="fw-semibold small">提现申请 #TW-20250915-001 已通过</div>
                <div class="text-muted xsmall">2 分钟前</div>
              </div>
            </li>
            <li class="list-group-item d-flex align-items-start">
              <i class="bi bi-clipboard-check me-2 mt-1"></i>
              <div>
                <div class="fw-semibold small">近 30 日任务通过率 92.1%</div>
                <div class="text-muted xsmall">30 分钟前</div>
              </div>
            </li>
          </ul>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>
<script src="p1-unify.js"></script>
<script src="p2-unify.js"></script>
</body>
</html>
<script src="p1-unify.js"></script>
<script src="p2-unify.js"></script>
</body>
</html>
